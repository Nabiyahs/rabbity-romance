<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch! Love - Game</title>
    <!--
      ÎîîÏûêÏù∏/Î¨∏Íµ¨Îäî ÏõêÎ≥∏ Ïú†ÏßÄ, Ïä§ÌÜ†Î¶¨Îäî ÎÇ¥Ïû• ÏÉÅÏàòÎ°ú ÏûÖÎ†•, JSON import/export ÏßÄÏõê
      Îã®Ïùº HTML ÌååÏùºÎ°ú ÏôÑÍ≤∞. Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨/Î≤àÎì§Îü¨ Î∂àÍ∞Ä.

      Î≥ëÌï© Í∑úÏπô(Merge Rules):
      1. Scene Î≥ëÌï©: scene.id Í∏∞Ï§Ä
         - Ï°¥Ïû¨ÌïòÎ©¥: Îπà Í∞íÏù¥ ÏïÑÎãå ÌïÑÎìúÎßå ÎçÆÏñ¥Ïì∞Í∏∞
         - ÏóÜÏúºÎ©¥: scenes Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
      2. Choice Î≥ëÌï©: choice.id Í∏∞Ï§Ä
         - Ï°¥Ïû¨ÌïòÎ©¥: label, outcome, nextSceneId Í∞±Ïã†
         - ÏóÜÏúºÎ©¥: Ìï¥Îãπ Ïî¨Ïùò choices[index] ÍµêÏ≤¥
      3. startSceneId, titleÏùÄ incoming Í∞íÏù¥ ÏûàÏúºÎ©¥ Í∞±Ïã†
    -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== Common ==================== */
        .screen {
            display: none !important;
        }

        .screen.active {
            display: block !important;
        }

        #mode-select-screen.active {
            display: flex !important;
        }

        #ending-success-screen.active,
        #ending-failure-screen.active {
            display: flex !important;
        }

        /* ==================== Main Game Screen ==================== */
        #main-screen {
            background: #F0EBF4;
            min-height: 100vh;
            height: 100vh;
            padding: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .wave-decoration {
            position: absolute;
            z-index: 0;
        }

        .wave-top-left {
            top: 0;
            left: 0;
            width: 120px;
            height: 60px;
            background: #A1C3D1;
            border-radius: 0 0 100% 0;
            opacity: 0.4;
        }

        .wave-bottom-right {
            bottom: 0;
            right: 0;
            width: 140px;
            height: 70px;
            background: #B39BC8;
            border-radius: 100% 0 0 0;
            opacity: 0.4;
        }

        .game-container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }

        .header {
            text-align: center;
            margin-bottom: 12px;
            position: relative;
            flex-shrink: 0;
        }

        .game-title {
            font-size: 24px;
            color: #E64398;
            margin-bottom: 0;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .header::before,
        .header::after {
            display: none;
        }

        .scene-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(179, 155, 200, 0.15);
            border: 3px solid #F172A1;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 0;
            position: relative;
        }

        .scene-text {
            font-size: 15px;
            line-height: 1.7;
            color: #5a5a5a;
            text-align: left;
            padding: 16px;
            background: #F0EBF4;
            border-radius: 12px;
            border-left: 4px solid #E64398;
            font-weight: 400;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 100%;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        .choice-card {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 4px 16px rgba(161, 195, 209, 0.2);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .choice-card::before {
            display: none;
        }

        .choice-card:nth-child(1) {
            border-color: #A1C3D1;
        }

        .choice-card:nth-child(1):active {
            border-color: #F172A1;
            transform: scale(0.98);
        }

        .choice-card:nth-child(2) {
            border-color: #B39BC8;
        }

        .choice-card:nth-child(2):active {
            border-color: #E64398;
            transform: scale(0.98);
        }

        .choice-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .choice-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .choice-card:nth-child(1) .choice-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23A1C3D1'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .choice-card:nth-child(2) .choice-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23B39BC8'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .choice-label {
            display: none;
        }

        .choice-text {
            font-size: 15px;
            color: #333;
            line-height: 1.5;
            font-weight: 500;
            flex: 1;
        }

        .choice-card:active .choice-text {
            color: #E64398;
        }

        /* ==================== Ending Success Screen ==================== */
        #ending-success-screen {
            background: #F172A1;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .wave-celebration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .celebrate-wave {
            position: absolute;
            width: 130%;
            left: -15%;
        }

        .celebrate-wave-1 {
            background: #E64398;
            height: 60px;
            top: 5%;
            border-radius: 50%;
            opacity: 0.4;
        }

        .celebrate-wave-2 {
            background: #B39BC8;
            height: 70px;
            top: 30%;
            border-radius: 50%;
            opacity: 0.4;
        }

        .celebrate-wave-3 {
            background: #A1C3D1;
            height: 80px;
            bottom: 10%;
            border-radius: 50%;
            opacity: 0.4;
        }

        .ending-container {
            max-width: 400px;
            width: 100%;
            max-height: calc(100vh - 32px);
            background: white;
            border-radius: 24px;
            padding: 24px 20px;
            box-shadow: 0 12px 40px rgba(230, 67, 152, 0.3);
            text-align: center;
            border: 3px solid #E64398;
            z-index: 10;
            position: relative;
            overflow-y: auto;
        }

        .ending-container::before,
        .ending-container::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E64398'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        .ending-container::before {
            top: 12px;
            left: 12px;
        }

        .ending-container::after {
            bottom: 12px;
            right: 12px;
        }

        .icon-container {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E64398'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .story-text-area {
            background: #F0EBF4;
            border: 3px solid #F172A1;
            border-radius: 16px;
            padding: 16px;
            min-height: 100px;
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.7;
            color: #666;
            text-align: left;
            font-weight: 400;
            white-space: pre-wrap;
        }

        .story-text-area::before {
            display: none;
        }

        .ending-message {
            font-size: 28px;
            color: #E64398;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 12px;
        }

        .congratulations {
            font-size: 14px;
            color: #E64398;
            font-style: italic;
            margin-top: 12px;
            font-weight: 400;
        }

        .success-decoration {
            margin-top: 16px;
            padding: 14px;
            background: #B39BC8;
            border-radius: 12px;
            color: white;
            font-size: 13px;
            box-shadow: 0 6px 20px rgba(179, 155, 200, 0.3);
            font-weight: 400;
        }

        .hearts-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 12px 0;
        }

        .hearts-row .heart-icon {
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
        }

        .hearts-row .heart-icon:nth-child(1) {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23F172A1'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .hearts-row .heart-icon:nth-child(2) {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E64398'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .hearts-row .heart-icon:nth-child(3) {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23B39BC8'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .hearts-row .heart-icon:nth-child(4) {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23A1C3D1'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .hearts-row .heart-icon:nth-child(5) {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23F172A1'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        /* ==================== Ending Failure Screen ==================== */
        #ending-failure-screen {
            background: #A1C3D1;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        #ending-failure-screen .ending-container {
            border-color: #B39BC8;
        }

        #ending-failure-screen .ending-container::before,
        #ending-failure-screen .ending-container::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23B39BC8'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        #ending-failure-screen .icon-container {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23A1C3D1'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            width: 48px;
            height: 48px;
            opacity: 0.5;
            animation: none;
        }

        #ending-failure-screen .story-text-area {
            border-color: #B39BC8;
            padding: 16px;
            min-height: 100px;
            margin-bottom: 16px;
        }

        #ending-failure-screen .story-text-area::before {
            display: none;
        }

        #ending-failure-screen .ending-message {
            font-size: 28px;
            color: #A1C3D1;
            letter-spacing: 4px;
        }

        .encouragement {
            font-size: 14px;
            color: #B39BC8;
            font-style: italic;
            margin-top: 12px;
            font-weight: 400;
        }

        .retry-hint {
            margin-top: 16px;
            padding: 14px;
            background: #F172A1;
            border-radius: 12px;
            color: white;
            font-size: 13px;
            font-weight: 400;
        }

        .wave-background {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .bg-wave {
            position: absolute;
            width: 120%;
            left: -10%;
        }

        .bg-wave-1 {
            background: #B39BC8;
            height: 80px;
            top: 20%;
            border-radius: 50%;
            opacity: 0.3;
        }

        .bg-wave-2 {
            background: #F172A1;
            height: 60px;
            bottom: 25%;
            border-radius: 50%;
            opacity: 0.3;
        }

        /* Restart button for ending screens */
        .restart-button {
            margin-top: 16px;
            padding: 12px 28px;
            background: #E64398;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Lato', sans-serif;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .restart-button:active {
            background: #F172A1;
            transform: scale(0.98);
        }

        /* ==================== Mode Selection Screen (Intro Design) ==================== */
        #mode-select-screen {
            background: #F0EBF4;
            min-height: 100vh;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }

        .intro-wave-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .intro-wave {
            position: absolute;
            width: 150%;
            height: 80px;
            left: -25%;
        }

        .intro-wave-1 {
            background: #A1C3D1;
            top: 0;
            border-radius: 0 0 50% 50%;
            transform: rotate(-2deg);
        }

        .intro-wave-2 {
            background: #F172A1;
            top: 12%;
            border-radius: 50%;
            height: 60px;
            transform: rotate(1deg);
        }

        .intro-wave-3 {
            background: #B39BC8;
            top: 25%;
            border-radius: 50%;
            height: 50px;
            transform: rotate(-1deg);
        }

        .intro-wave-4 {
            background: #E64398;
            top: 38%;
            border-radius: 50%;
            height: 45px;
            transform: rotate(2deg);
        }

        .intro-wave-5 {
            background: #A1C3D1;
            bottom: 0;
            border-radius: 50% 50% 0 0;
            height: 80px;
            transform: rotate(-1deg);
        }

        .intro-container {
            text-align: center;
            z-index: 10;
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .intro-title-wrapper {
            background: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(230, 67, 152, 0.25);
            border: 3px solid #F172A1;
            position: relative;
        }

        .intro-title-wrapper::before,
        .intro-title-wrapper::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E64398'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        .intro-title-wrapper::before {
            top: 12px;
            left: 16px;
        }

        .intro-title-wrapper::after {
            bottom: 12px;
            right: 16px;
        }

        .intro-title {
            font-size: 36px;
            color: #E64398;
            margin-bottom: 0;
            letter-spacing: 4px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .intro-subtitle {
            font-size: 12px;
            color: #B39BC8;
            margin-top: 12px;
            font-weight: 400;
            letter-spacing: 2px;
        }

        .intro-floating-heart {
            display: none;
        }

        .mode-toggle-container {
            margin-top: 30px;
            background: white;
            border-radius: 20px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 8px 24px rgba(230, 67, 152, 0.2);
            border: 3px solid #F172A1;
        }

        .mode-btn {
            padding: 14px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #B39BC8;
            font-family: 'Lato', sans-serif;
            letter-spacing: 1px;
            border-radius: 14px;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: #E64398;
            color: white;
        }

        .mode-btn:active {
            transform: scale(0.98);
        }

        /* Back Button in Scene Container */
        .back-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 36px;
            height: 36px;
            padding: 0;
            background: #B39BC8;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .back-btn:active {
            background: #E64398;
            transform: scale(0.95);
        }

        .back-btn.visible {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Mode Selection Screen (Intro Design) -->
    <div id="mode-select-screen" class="screen active">
        <div class="intro-wave-layer">
            <div class="intro-wave intro-wave-1"></div>
            <div class="intro-wave intro-wave-2"></div>
            <div class="intro-wave intro-wave-3"></div>
            <div class="intro-wave intro-wave-4"></div>
            <div class="intro-wave intro-wave-5"></div>
        </div>

        <div class="intro-floating-heart"></div>
        <div class="intro-floating-heart"></div>
        <div class="intro-floating-heart"></div>
        <div class="intro-floating-heart"></div>

        <div class="intro-container">
            <div class="intro-title-wrapper">
                <h1 class="intro-title">CATCH! LOVE</h1>
                <div class="intro-subtitle">A ROMANTIC ADVENTURE AWAITS</div>
            </div>
            <div class="mode-toggle-container">
                <button class="mode-btn active" id="mode-real">ÎèåÏù¥ÌÇ¨ Ïàò ÏóÜÎäî</button>
                <button class="mode-btn" id="mode-retry">ÎèåÏù¥ÌÇ¨ Ïàò ÏûàÎäî</button>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="main-screen" class="screen">
        <div class="wave-decoration wave-top-left"></div>
        <div class="wave-decoration wave-bottom-right"></div>

        <div class="game-container">
            <div class="header">
                <h1 class="game-title">üíï CATCH! LOVE üíï</h1>
            </div>

            <div class="scene-container">
                <button class="back-btn" id="back-btn">&lt;</button>
                <div class="scene-text" id="scene-content"></div>
            </div>

            <div class="choices-container">
                <div class="choice-card" id="choice-a" data-choice="0">
                    <div class="choice-content">
                        <div class="choice-icon"></div>
                        <div class="choice-label">Option A</div>
                        <div class="choice-text" id="choice-a-text"></div>
                    </div>
                </div>

                <div class="choice-card" id="choice-b" data-choice="1">
                    <div class="choice-content">
                        <div class="choice-icon"></div>
                        <div class="choice-label">Option B</div>
                        <div class="choice-text" id="choice-b-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ending Success Screen -->
    <div id="ending-success-screen" class="screen">
        <div class="wave-celebration">
            <div class="celebrate-wave celebrate-wave-1"></div>
            <div class="celebrate-wave celebrate-wave-2"></div>
            <div class="celebrate-wave celebrate-wave-3"></div>
        </div>

        <div class="ending-container">
            <div class="icon-container"></div>

            <div class="story-text-area" id="success-story-text"></div>

            <div class="hearts-row">
                <div class="heart-icon"></div>
                <div class="heart-icon"></div>
                <div class="heart-icon"></div>
                <div class="heart-icon"></div>
                <div class="heart-icon"></div>
            </div>

            <div class="ending-message">THE END</div>

            <div class="congratulations">
                Congratulations! You've caught love! üéâ
            </div>

            <div class="success-decoration">
                True love conquers all. Your hearts are now forever intertwined! üíë
            </div>

            <button class="restart-button" id="restart-success">Restart Journey</button>
        </div>
    </div>

    <!-- Ending Failure Screen -->
    <div id="ending-failure-screen" class="screen">
        <div class="wave-background">
            <div class="bg-wave bg-wave-1"></div>
            <div class="bg-wave bg-wave-2"></div>
        </div>

        <div class="ending-container">
            <div class="icon-container"></div>

            <div class="story-text-area" id="failure-story-text"></div>

            <div class="ending-message">MAYBE NEXT TIME...</div>

            <div class="encouragement">
                Every ending is a new beginning. Try again? üí´
            </div>

            <div class="retry-hint">
                Love is a journey of many paths. Choose differently and discover new possibilities! üåà
            </div>

            <button class="restart-button" id="restart-failure">Restart Journey</button>
        </div>
    </div>

    <script>
        // ==================== STORY DATA ====================
        // JSON ÌååÏùºÏóêÏÑú Î°úÎìúÎê®
        let STORY = null;

        // JSON ÌååÏùº Î°úÎìú
        async function loadStoryData() {
            try {
                // URL Ïù∏ÏΩîÎî© Ï†ÅÏö© (! Î¨∏Ïûê Îì± ÌäπÏàòÎ¨∏Ïûê Ï≤òÎ¶¨)
                const response = await fetch('./Catch%21-Love.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                STORY = await response.json();
                return true;
            } catch (error) {
                console.error('Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                return false;
            }
        }

        // ==================== STATE ====================
        let currentSceneId = null;
        let crumbs = [];
        let sceneHistory = []; // Ïù¥Ï†Ñ Ïî¨ Í∏∞Î°ù (ÎêòÎèåÏïÑÍ∞ÄÍ∏∞ Í∏∞Îä•Ïö©)
        let gameMode = 'real'; // 'real' (Ïù∏ÏÉùÏùÄ Ïã§Ï†Ñ) ÎòêÎäî 'retry' (ÎèåÏù¥ÌÇ¨ Ïàò ÏûàÎäî)


        // ==================== HELPERS ====================
        function qs(sel) {
            return document.querySelector(sel);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            qs('#' + screenId).classList.add('active');
        }

        function findScene(sceneId) {
            return STORY.scenes.find(s => s.id === sceneId);
        }

        // Ïú†Ìö®Ìïú choiceÏù∏ÏßÄ ÌôïÏù∏ (labelÍ≥º nextSceneIdÍ∞Ä Î™®Îëê ÏûàÏñ¥Ïïº Ìï®)
        function isValidChoice(choice) {
            if (!choice) return false;
            // ÏóîÎî©(success/failure)Ïù∏ Í≤ΩÏö∞ labelÎßå ÏûàÏúºÎ©¥ Îê®
            if (choice.outcome === 'success' || choice.outcome === 'failure') {
                return choice.label && choice.label.trim() !== '';
            }
            // continueÏù∏ Í≤ΩÏö∞ labelÍ≥º nextSceneId Î™®Îëê ÌïÑÏöî
            return choice.label && choice.label.trim() !== '' && choice.nextSceneId && choice.nextSceneId.trim() !== '';
        }

        function validate(story) {
            const errors = [];

            if (!story.startSceneId) {
                errors.push('ÏãúÏûë Ïî¨ IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
            } else if (!story.scenes.find(s => s.id === story.startSceneId)) {
                errors.push(`ÏãúÏûë Ïî¨ ${story.startSceneId}ÏùÑ(Î•º) Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
            }

            story.scenes.forEach(scene => {
                // ÏóîÎî© Ïî¨ÏùÄ choiceÍ∞Ä ÏóÜÏñ¥ÎèÑ Îê®
                if (scene.isEnding) return;

                // ÏóîÎî©Ïù¥ ÏïÑÎãå Ïî¨ÏùÄ ÏµúÏÜå ÌïòÎÇòÏùò Ïú†Ìö®Ìïú choiceÍ∞Ä ÌïÑÏöî
                const validChoices = (scene.choices || []).filter(isValidChoice);
                if (validChoices.length === 0) {
                    errors.push(`Ïî¨ ${scene.id}: ÏµúÏÜå ÌïòÎÇòÏùò Ïú†Ìö®Ìïú ÏÑ†ÌÉùÏßÄÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.`);
                }

                // Ïú†Ìö®Ìïú choiceÏùò nextSceneIdÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
                validChoices.forEach((choice, idx) => {
                    if (choice.outcome === 'continue' && choice.nextSceneId) {
                        if (!story.scenes.find(s => s.id === choice.nextSceneId)) {
                            errors.push(`Ïî¨ ${scene.id}, ÏÑ†ÌÉùÏßÄ "${choice.label}": nextSceneId ${choice.nextSceneId}ÏùÑ(Î•º) Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                        }
                    }
                });
            });

            return errors;
        }

        // ==================== GAME LOGIC ====================
        function selectMode(mode) {
            gameMode = mode;
            sceneHistory = [];

            // ÌÜ†Í∏Ä Î≤ÑÌäº active ÏÉÅÌÉú Î≥ÄÍ≤Ω
            qs('#mode-real').classList.toggle('active', mode === 'real');
            qs('#mode-retry').classList.toggle('active', mode === 'retry');

            // ÎèåÏù¥ÌÇ¨ Ïàò ÏûàÎäî Î™®ÎìúÏùº ÎïåÎßå Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº ÌëúÏãú
            const backBtn = qs('#back-btn');
            if (mode === 'retry') {
                backBtn.classList.add('visible');
            } else {
                backBtn.classList.remove('visible');
            }

            startGame();
        }

        function goBack() {
            if (sceneHistory.length > 1) {
                // ÌòÑÏû¨ Ïî¨ÏùÑ Ï†úÍ±∞ÌïòÍ≥† Ïù¥Ï†Ñ Ïî¨ÏúºÎ°ú
                sceneHistory.pop();
                const prevSceneId = sceneHistory.pop();
                showScene(prevSceneId);
            }
        }

        function startGame() {
            currentSceneId = STORY.startSceneId;
            crumbs = [];
            sceneHistory = [];
            showScene(currentSceneId);
        }

        function showScene(sceneId) {
            const scene = findScene(sceneId);
            if (!scene) {
                console.warn(`Ïî¨ ${sceneId}ÏùÑ(Î•º) Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                return;
            }

            currentSceneId = sceneId;
            crumbs.push(scene.name);
            sceneHistory.push(sceneId);

            // Check if ending scene
            if (scene.isEnding) {
                showEndingScreen('failure', scene.endingInfo?.summary || scene.content);
                return;
            }

            showScreen('main-screen');

            qs('#scene-content').textContent = scene.content || '';

            const choices = scene.choices || [];
            const choiceA = qs('#choice-a');
            const choiceB = qs('#choice-b');
            const choicesContainer = qs('.choices-container');

            // Ïú†Ìö®Ìïú choice ÌïÑÌÑ∞ÎßÅ
            const validChoiceA = isValidChoice(choices[0]);
            const validChoiceB = isValidChoice(choices[1]);

            // Choice A Ï≤òÎ¶¨
            if (validChoiceA) {
                choiceA.style.display = '';
                qs('#choice-a-text').textContent = choices[0].label;
                choiceA.dataset.outcome = choices[0].outcome || 'continue';
                choiceA.dataset.nextSceneId = choices[0].nextSceneId || '';
            } else {
                choiceA.style.display = 'none';
            }

            // Choice B Ï≤òÎ¶¨
            if (validChoiceB) {
                choiceB.style.display = '';
                qs('#choice-b-text').textContent = choices[1].label;
                choiceB.dataset.outcome = choices[1].outcome || 'continue';
                choiceB.dataset.nextSceneId = choices[1].nextSceneId || '';
            } else {
                choiceB.style.display = 'none';
            }

            // Ïú†Ìö®Ìïú choiceÍ∞Ä ÌïòÎÇòÎèÑ ÏóÜÏúºÎ©¥ Ïª®ÌÖåÏù¥ÎÑà Ïà®ÍπÄ
            if (!validChoiceA && !validChoiceB) {
                choicesContainer.style.display = 'none';
            } else {
                choicesContainer.style.display = '';
            }
        }

        function handleChoice(choiceElement) {
            const outcome = choiceElement.dataset.outcome;
            const nextSceneId = choiceElement.dataset.nextSceneId;

            switch (outcome) {
                case 'continue':
                    if (nextSceneId) {
                        showScene(nextSceneId);
                    } else {
                        alert('Îã§Ïùå Ïî¨Ïù¥ ÏßÄÏ†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    }
                    break;

                case 'success':
                    showEndingScreen('success', 'ÎãπÏã†ÏùÄ Ïö©Í∏∞Î•º ÎÇ¥Ïñ¥ ÏßÑÏã¨ÏùÑ Ï†ÑÌñàÍ≥†, Í∑∏ ÏÇ¨ÎûåÎèÑ Í∞ôÏùÄ ÎßàÏùåÏù¥ÏóàÎã§.\n\nÎëê ÏÇ¨ÎûåÏùÄ ÏÜêÏùÑ Ïû°Í≥† Ìï®Íªò Í±∑Í∏∞ ÏãúÏûëÌïúÎã§.\n\nÏù¥Í≤ÉÏù¥ ÏßÑÏ†ïÌïú ÏÇ¨ÎûëÏùò ÏãúÏûëÏù¥Îã§.');
                    break;

                case 'failure':
                    showEndingScreen('failure', '\"Í≥†ÎßôÏßÄÎßå... ÎÇòÎäî ÎÑàÎ•º ÏπúÍµ¨Î°úÎßå ÏÉùÍ∞ÅÌï¥.\"\n\nÍ∑∏ ÏÇ¨ÎûåÏùò ÎßêÏóê ÎãπÏã†Ïùò ÎßàÏùåÏùÄ Î¨¥ÎÑàÏßÑÎã§.\n\nÏñ¥ÏÉâÌïú Ïπ®Î¨µÏù¥ ÌùêÎ•¥Í≥†, Îëê ÏÇ¨ÎûåÏùÄ ÏÑúÎ°ú Îã§Î•∏ Î∞©Ìñ•ÏúºÎ°ú Í±∏Ïñ¥Í∞ÑÎã§.');
                    break;
            }
        }

        function showEndingScreen(type, storyText) {
            if (type === 'success') {
                showScreen('ending-success-screen');
                qs('#success-story-text').textContent = storyText || '';
            } else {
                showScreen('ending-failure-screen');
                qs('#failure-story-text').textContent = storyText || '';
            }
        }

        function restartGame() {
            currentSceneId = null;
            crumbs = [];
            sceneHistory = [];
            showScreen('mode-select-screen');
        }

        // ==================== EVENT HANDLERS ====================
        async function init() {
            // Ï¥àÍ∏∞ ÌôîÎ©¥ ÏÉÅÌÉú ÏÑ§Ï†ï - Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥Îßå ÌëúÏãú
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            qs('#mode-select-screen').classList.add('active');

            // JSON ÌååÏùºÏóêÏÑú Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const loaded = await loadStoryData();
            if (!loaded) {
                return;
            }

            const errors = validate(STORY);
            if (errors.length > 0) {
                console.warn('Ïä§ÌÜ†Î¶¨ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Í≤ΩÍ≥†:', errors);
                // Í≤ΩÍ≥†Îßå ÌëúÏãúÌïòÍ≥† Í≤åÏûÑÏùÄ Í≥ÑÏÜç ÏßÑÌñâ
            }

            // Mode selection handlers
            qs('#mode-real').addEventListener('click', () => selectMode('real'));
            qs('#mode-retry').addEventListener('click', () => selectMode('retry'));

            // Back button handler
            qs('#back-btn').addEventListener('click', goBack);

            // Choice handlers
            qs('#choice-a').addEventListener('click', function() {
                handleChoice(this);
            });

            qs('#choice-b').addEventListener('click', function() {
                handleChoice(this);
            });

            // Restart buttons
            qs('#restart-success').addEventListener('click', restartGame);
            qs('#restart-failure').addEventListener('click', restartGame);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
